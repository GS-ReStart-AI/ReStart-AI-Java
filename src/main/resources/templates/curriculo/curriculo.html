<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ReStart.AI - Currículo</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" th:href="@{/css/curriculo.css}">
</head>
<body>

<header class="top-navbar">
    <div class="top-brand">
        <img th:src="@{/images/logo.png}" alt="ReStart.AI" class="brand-logo">
        <span class="brand-name">ReStart.AI</span>
    </div>

    <a th:href="@{/perfil(usuarioId=${usuarioId})}" class="btn-perfil">Meu Perfil</a>
</header>

<main class="curriculo-main">

    <section class="card-wrapper">
        <div class="curriculo-card">
            <h1 class="card-title">Seu currículo</h1>

            <form id="uploadForm" class="upload-form" enctype="multipart/form-data">
                <input type="hidden" id="usuarioId" name="usuarioId" th:value="${usuarioId}">

                <div class="form-group">
                    <label for="arquivo" class="form-label">Envie seu currículo em PDF</label>
                    <input id="arquivo"
                           name="arquivo"
                           type="file"
                           accept="application/pdf"
                           class="file-input"
                           required>
                </div>

                <div id="uploadStatus" class="status-text"></div>

                <button type="submit" class="btn-principal">
                    enviar
                </button>
            </form>
        </div>
    </section>

    <section id="analiseSection" class="card-wrapper hidden">
        <div class="analise-card">
            <h2 class="card-title">Analise da IA</h2>

            <p class="analise-subtitle">
                Após o envio do PDF, clique no botão abaixo para gerar os pontos sobre o seu currículo.
            </p>

            <button id="analyzeBtn" class="btn-secundario" disabled>
                Analisar currículo com IA
            </button>

            <div class="analise-grid">

                <div class="analise-bloco">
                    <h3>1. Resumo do Perfil Profissional</h3>
                    <p id="resumoPerfil"></p>
                </div>

                <div class="analise-bloco">
                    <h3>2. Principais Competências e Habilidades</h3>
                    <p id="competenciasHabilidades"></p>
                </div>

                <div class="analise-bloco">
                    <h3>3. Áreas de Atuação Atuais Possíveis</h3>
                    <p id="areasAtuais"></p>
                </div>

                <div class="analise-bloco">
                    <h3>4. Áreas Alternativas para Migração de Carreira</h3>
                    <p id="areasAlternativas"></p>
                </div>
            </div>
        </div>
    </section>

</main>

<footer class="footer">
    <span>ReStart.AI © 2025</span>
</footer>

<script>
    const uploadForm = document.getElementById('uploadForm');
    const uploadStatus = document.getElementById('uploadStatus');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const analiseSection = document.getElementById('analiseSection');
    const usuarioIdInput = document.getElementById('usuarioId');

    const resumoPerfilEl = document.getElementById('resumoPerfil');
    const competenciasEl = document.getElementById('competenciasHabilidades');
    const areasAtuaisEl = document.getElementById('areasAtuais');
    const areasAlternativasEl = document.getElementById('areasAlternativas');

    let curriculoId = null;

    uploadForm.addEventListener('submit', async function (e) {
        e.preventDefault();

        const arquivoInput = document.getElementById('arquivo');
        if (!arquivoInput.files.length) {
            uploadStatus.textContent = 'Selecione um PDF primeiro.';
            uploadStatus.classList.add('status-erro');
            return;
        }

        const formData = new FormData();
        formData.append('usuarioId', usuarioIdInput.value);
        formData.append('arquivo', arquivoInput.files[0]);

        uploadStatus.textContent = 'Enviando currículo...';
        uploadStatus.className = 'status-text';
        resumoPerfilEl.textContent = '';
        competenciasEl.textContent = '';
        areasAtuaisEl.textContent = '';
        areasAlternativasEl.textContent = '';
        analyzeBtn.disabled = true;
        curriculoId = null;
        analiseSection.classList.add('hidden');

        try {
            const response = await fetch('/api/curriculos/upload', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                uploadStatus.textContent = 'Erro ao enviar currículo.';
                uploadStatus.classList.add('status-erro');
                return;
            }

            const data = await response.json();
            curriculoId = data.id;

            uploadStatus.textContent = 'Currículo enviado com sucesso.';
            uploadStatus.classList.add('status-ok');

            analiseSection.classList.remove('hidden');
            analyzeBtn.disabled = !curriculoId;
        } catch (err) {
            uploadStatus.textContent = 'Erro inesperado ao enviar currículo.';
            uploadStatus.classList.add('status-erro');
        }
    });

    analyzeBtn.addEventListener('click', async function () {
        if (!curriculoId) {
            return;
        }

        analyzeBtn.disabled = true;
        analyzeBtn.textContent = 'Gerando análise...';

        resumoPerfilEl.textContent = '';
        competenciasEl.textContent = '';
        areasAtuaisEl.textContent = '';
        areasAlternativasEl.textContent = '';

        try {
            const response = await fetch('/api/curriculos/' + curriculoId + '/analisar', {
                method: 'POST'
            });

            if (!response.ok) {
                resumoPerfilEl.textContent = 'Erro ao analisar currículo.';
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'Analisar currículo com IA';
                return;
            }

            const text = await response.text();

            const sections = parseAnaliseIa(text);

            resumoPerfilEl.innerHTML = formatSectionText(sections.resumo);
            competenciasEl.innerHTML = formatSectionText(sections.competencias);
            areasAtuaisEl.innerHTML = formatSectionText(sections.areasAtuais);
            areasAlternativasEl.innerHTML = formatSectionText(sections.areasAlternativas);
        } catch (err) {
            resumoPerfilEl.textContent = 'Erro inesperado na análise.';
        } finally {
            analyzeBtn.disabled = false;
            analyzeBtn.textContent = 'Analisar currículo com IA';
        }
    });

    function formatSectionText(texto) {
        if (!texto || !texto.trim()) {
            return 'Sem informações.';
        }

        let html = texto.trim();

        html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

        const lower = html.toLowerCase();
        const idx = lower.indexOf('justificativa:');

        if (idx !== -1) {
            const tituloParte = html.slice(0, idx).trim();
            const justificativaParte = html.slice(idx + 'justificativa:'.length).trim();

            html =
                (tituloParte
                    ? '<div class="analise-sugestao">' + tituloParte + '</div>'
                    : '') +
                (justificativaParte
                    ? '<div class="analise-justificativa"><span class="secao-label">Justificativa:</span> ' +
                    justificativaParte +
                    '</div>'
                    : '');
        }

        return html;
    }

    function parseAnaliseIa(texto) {
        const resultado = {
            resumo: '',
            competencias: '',
            areasAtuais: '',
            areasAlternativas: ''
        };

        const partes = texto.split(/\n(?=\d\.)/);

        partes.forEach(parte => {
            const p = parte.trim();

            if (/^1\./.test(p)) {
                resultado.resumo = p.replace(/^1\.\s*/i, '').trim();
            } else if (/^2\./.test(p)) {
                resultado.competencias = p.replace(/^2\.\s*/i, '').trim();
            } else if (/^3\./.test(p)) {
                resultado.areasAtuais = p.replace(/^3\.\s*/i, '').trim();
            } else if (/^4\./.test(p)) {
                resultado.areasAlternativas = p.replace(/^4\.\s*/i, '').trim();
            }
        });

        if (!resultado.resumo && !resultado.competencias &&
            !resultado.areasAtuais && !resultado.areasAlternativas) {
            resultado.resumo = texto.trim();
        }

        return resultado;
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
