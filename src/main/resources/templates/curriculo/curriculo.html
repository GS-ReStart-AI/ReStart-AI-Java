<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" th:lang="${#locale.language}">
<head>
    <meta charset="UTF-8">
    <title>ReStart.AI - Resume</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" th:href="@{/css/curriculo.css}">
</head>
<body>

<header class="top-navbar">
    <div class="top-brand">
        <img th:src="@{/images/logo.png}" alt="ReStart.AI" class="brand-logo">
        <span class="brand-name">ReStart.AI</span>
    </div>

    <div class="top-right">
        <a th:href="@{/perfil(usuarioId=${usuarioId})}"
           class="btn-perfil"
           th:text="#{curriculo.button.profile}">My Profile</a>

        <div class="lang-dropdown">
            <button class="lang-btn" type="button">üåê</button>
            <div class="lang-menu">
                <a th:href="@{/curriculo(usuarioId=${usuarioId},lang='pt_BR')}">PT</a>
                <a th:href="@{/curriculo(usuarioId=${usuarioId},lang='en')}">EN</a>
            </div>
        </div>
    </div>
</header>

<main class="curriculo-main">

    <section class="card-wrapper">
        <div class="curriculo-card">
            <h1 class="card-title" th:text="#{curriculo.title}">Your resume</h1>

            <form id="uploadForm" class="upload-form" enctype="multipart/form-data">
                <input type="hidden" id="usuarioId" name="usuarioId" th:value="${usuarioId}">

                <div class="form-group">
                    <label for="arquivo" class="form-label"
                           th:text="#{curriculo.label.upload}">Upload your resume in PDF</label>
                    <input id="arquivo"
                           name="arquivo"
                           type="file"
                           accept="application/pdf"
                           class="file-input"
                           required>
                </div>

                <div id="uploadStatus" class="status-text"></div>

                <button type="submit" class="btn-principal"
                        th:text="#{curriculo.button.upload}">Upload</button>
            </form>
        </div>
    </section>

    <section id="analiseSection" class="card-wrapper hidden">
        <div class="analise-card">
            <h2 class="card-title" th:text="#{curriculo.analysis.title}">AI Analysis</h2>

            <p class="analise-subtitle"
               th:text="#{curriculo.analysis.subtitle}">
                After sending the PDF, click the button below to generate insights about your resume.
            </p>

            <button id="analyzeBtn"
                    class="btn-secundario"
                    disabled
                    th:text="#{curriculo.button.analyze}">
                Analyze resume with AI
            </button>

            <div class="analise-grid">

                <div class="analise-bloco">
                    <h3 th:text="#{curriculo.section1.title}">1. Summary of Professional Profile</h3>
                    <p id="resumoPerfil"></p>
                </div>

                <div class="analise-bloco">
                    <h3 th:text="#{curriculo.section2.title}">2. Key Skills and Competencies</h3>
                    <p id="competenciasHabilidades"></p>
                </div>

                <div class="analise-bloco">
                    <h3 th:text="#{curriculo.section3.title}">3. Possible Current Areas of Work</h3>
                    <p id="areasAtuais"></p>
                </div>

                <div class="analise-bloco">
                    <h3 th:text="#{curriculo.section4.title}">4. Alternative Areas for Career Change</h3>
                    <p id="areasAlternativas"></p>
                </div>
            </div>
        </div>
    </section>

</main>

<footer class="footer">
    <span>ReStart.AI ¬© 2025</span>
</footer>

<script th:inline="javascript">
    const MSG_SELECT_PDF          = /*[[#{curriculo.upload.selectFirst}]]*/ 'Please select a PDF first.';
    const MSG_SENDING             = /*[[#{curriculo.upload.sending}]]*/ 'Uploading resume...';
    const MSG_UPLOAD_ERROR        = /*[[#{curriculo.upload.error}]]*/ 'Error uploading resume.';
    const MSG_UPLOAD_OK           = /*[[#{curriculo.upload.success}]]*/ 'Resume uploaded successfully.';
    const MSG_UPLOAD_UNEXPECTED   = /*[[#{curriculo.upload.errorUnexpected}]]*/ 'Unexpected error while uploading resume.';

    const MSG_ANALYZE_RUNNING     = /*[[#{curriculo.button.analyze.loading}]]*/ 'Generating analysis...';
    const MSG_ANALYZE_ERROR       = /*[[#{curriculo.error.analyze}]]*/ 'Error analyzing resume.';
    const MSG_ANALYZE_UNEXPECTED  = /*[[#{curriculo.error.unexpected}]]*/ 'Unexpected error during analysis.';
    const MSG_ANALYZE_BTN         = /*[[#{curriculo.button.analyze}]]*/ 'Analyze resume with AI';

    const MSG_NO_INFO             = /*[[#{curriculo.section.empty}]]*/ 'No information available.';
    const LABEL_JUSTIFICATIVA     = /*[[#{curriculo.label.justificativa}]]*/ 'Justification:';

    const uploadForm = document.getElementById('uploadForm');
    const uploadStatus = document.getElementById('uploadStatus');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const analiseSection = document.getElementById('analiseSection');
    const usuarioIdInput = document.getElementById('usuarioId');

    const resumoPerfilEl = document.getElementById('resumoPerfil');
    const competenciasEl = document.getElementById('competenciasHabilidades');
    const areasAtuaisEl = document.getElementById('areasAtuais');
    const areasAlternativasEl = document.getElementById('areasAlternativas');

    let curriculoId = null;

    uploadForm.addEventListener('submit', async function (e) {
        e.preventDefault();

        const arquivoInput = document.getElementById('arquivo');
        if (!arquivoInput.files.length) {
            uploadStatus.textContent = MSG_SELECT_PDF;
            uploadStatus.classList.add('status-erro');
            return;
        }

        const formData = new FormData();
        formData.append('usuarioId', usuarioIdInput.value);
        formData.append('arquivo', arquivoInput.files[0]);

        uploadStatus.textContent = MSG_SENDING;
        uploadStatus.className = 'status-text';
        resumoPerfilEl.textContent = '';
        competenciasEl.textContent = '';
        areasAtuaisEl.textContent = '';
        areasAlternativasEl.textContent = '';
        analyzeBtn.disabled = true;
        curriculoId = null;
        analiseSection.classList.add('hidden');

        try {
            const response = await fetch('/api/curriculos/upload', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                uploadStatus.textContent = MSG_UPLOAD_ERROR;
                uploadStatus.classList.add('status-erro');
                return;
            }

            const data = await response.json();
            curriculoId = data.id;

            uploadStatus.textContent = MSG_UPLOAD_OK;
            uploadStatus.classList.add('status-ok');

            analiseSection.classList.remove('hidden');
            analyzeBtn.disabled = !curriculoId;
        } catch (err) {
            uploadStatus.textContent = MSG_UPLOAD_UNEXPECTED;
            uploadStatus.classList.add('status-erro');
        }
    });

    analyzeBtn.addEventListener('click', async function () {
        if (!curriculoId) {
            return;
        }

        analyzeBtn.disabled = true;
        analyzeBtn.textContent = MSG_ANALYZE_RUNNING;

        resumoPerfilEl.textContent = '';
        competenciasEl.textContent = '';
        areasAtuaisEl.textContent = '';
        areasAlternativasEl.textContent = '';

        try {
            const response = await fetch('/api/curriculos/' + curriculoId + '/analisar', {
                method: 'POST'
            });

            if (!response.ok) {
                resumoPerfilEl.textContent = MSG_ANALYZE_ERROR;
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = MSG_ANALYZE_BTN;
                return;
            }

            const text = await response.text();

            const sections = parseAnaliseIa(text);

            resumoPerfilEl.innerHTML = formatSectionText(sections.resumo);
            competenciasEl.innerHTML = formatSectionText(sections.competencias);
            areasAtuaisEl.innerHTML = formatSectionText(sections.areasAtuais);
            areasAlternativasEl.innerHTML = formatSectionText(sections.areasAlternativas);
        } catch (err) {
            resumoPerfilEl.textContent = MSG_ANALYZE_UNEXPECTED;
        } finally {
            analyzeBtn.disabled = false;
            analyzeBtn.textContent = MSG_ANALYZE_BTN;
        }
    });

    function formatSectionText(texto) {
        if (!texto || !texto.trim()) {
            return MSG_NO_INFO;
        }

        let html = texto.trim();

        html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

        const lower = html.toLowerCase();
        const labelLower = LABEL_JUSTIFICATIVA.toLowerCase();
        const idx = lower.indexOf(labelLower);

        if (idx !== -1) {
            const tituloParte = html.slice(0, idx).trim();
            const justificativaParte = html.slice(idx + LABEL_JUSTIFICATIVA.length).trim();

            html =
                (tituloParte
                    ? '<div class="analise-sugestao">' + tituloParte + '</div>'
                    : '') +
                (justificativaParte
                    ? '<div class="analise-justificativa"><span class="secao-label">'
                    + LABEL_JUSTIFICATIVA +
                    '</span> ' +
                    justificativaParte +
                    '</div>'
                    : '');
        }

        return html;
    }

    function parseAnaliseIa(texto) {
        const resultado = {
            resumo: '',
            competencias: '',
            areasAtuais: '',
            areasAlternativas: ''
        };

        const partes = texto.split(/\n(?=\d\.)/);

        partes.forEach(parte => {
            const p = parte.trim();

            if (/^1\./.test(p)) {
                resultado.resumo = p.replace(/^1\.\s*/i, '').trim();
            } else if (/^2\./.test(p)) {
                resultado.competencias = p.replace(/^2\.\s*/i, '').trim();
            } else if (/^3\./.test(p)) {
                resultado.areasAtuais = p.replace(/^3\.\s*/i, '').trim();
            } else if (/^4\./.test(p)) {
                resultado.areasAlternativas = p.replace(/^4\.\s*/i, '').trim();
            }
        });

        if (!resultado.resumo &&
            !resultado.competencias &&
            !resultado.areasAtuais &&
            !resultado.areasAlternativas) {
            resultado.resumo = texto.trim();
        }

        return resultado;
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
